<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GLB Viewer</title>
  <style>
    html,body{height:100%;margin:0;background:#0b0b0b}
    #c{position:fixed;inset:0}
    #load{position:fixed;inset:0;display:grid;place-items:center;color:#ddd;font:14px system-ui}
  </style>
</head>
<body>
  <div id="load">Loading 3D…</div>
  <canvas id="c"></canvas>

  <script type="module">
    // ===== config =====
    const GLB_URL = './butterfly.glb'; // <-- имя твоего файла .glb

    // ===== imports =====
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/DRACOLoader.js';
    import { KTX2Loader } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/KTX2Loader.js';
    import { MeshoptDecoder } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/libs/meshopt_decoder.module.js';
    import { RoomEnvironment } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/environments/RoomEnvironment.js';

    // ===== basics =====
    const canvas  = document.getElementById('c');
    const loading = document.getElementById('load');

    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
    renderer.outputColorSpace   = THREE.SRGBColorSpace;
    renderer.toneMapping        = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure= 1.0;

    const scene   = new THREE.Scene();
    const camera  = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
    const controls= new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // env + немного света
    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
    const key = new THREE.DirectionalLight(0xffffff, 1); key.position.set(5,6,4);
    const fill= new THREE.DirectionalLight(0xffffff, .4); fill.position.set(-4,2,-5);
    scene.add(key, fill);

    // ===== loaders (на случай draco/ktx2/meshopt) =====
    const loader = new GLTFLoader();

    const draco = new DRACOLoader();
    draco.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/libs/draco/');
    loader.setDRACOLoader(draco);

    const ktx2 = new KTX2Loader()
      .setTranscoderPath('https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/libs/basis/')
      .detectSupport(renderer);
    loader.setKTX2Loader(ktx2);

    loader.setMeshoptDecoder(MeshoptDecoder);

    let mixer = null;
    const clock = new THREE.Clock();

    // ===== load model =====
    loader.load(
      GLB_URL,
      (gltf) => {
        const root = gltf.scene || gltf.scenes[0];
        scene.add(root);

        // --- fit camera to model (НЕ трогаем трансформы модели) ---
        const box = new THREE.Box3().setFromObject(root);
        const size = new THREE.Vector3(); box.getSize(size);
        const center = new THREE.Vector3(); box.getCenter(center);
        const maxDim = Math.max(size.x, size.y, size.z);

        const fov = THREE.MathUtils.degToRad(camera.fov);
        const dist = (maxDim/2) / Math.tan(fov/2);
        const dir = new THREE.Vector3(1,0.7,1).normalize();
        camera.position.copy(center).add(dir.multiplyScalar(dist*1.2));
        camera.near = Math.max(dist/100, 0.01);
        camera.far  = dist*100;
        camera.updateProjectionMatrix();
        controls.target.copy(center);
        controls.update();

        // --- play animations if present ---
        if (gltf.animations && gltf.animations.length) {
          mixer = new THREE.AnimationMixer(root);
          gltf.animations.forEach(clip => mixer.clipAction(clip).reset().play());
        } else {
          console.log('No animations in GLB');
        }

        loading.style.display = 'none';
        animate();
      },
      (xhr) => {
        loading.textContent = xhr.total ? `Loading 3D… ${(xhr.loaded/xhr.total*100|0)}%` : 'Loading 3D…';
      },
      (err) => {
        loading.textContent = 'Failed to load model';
        console.error('GLB load error:', err);
      }
    );

    // ===== loop & resize =====
    function animate(){
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      if (mixer) mixer.update(dt);
      controls.update();
      renderer.render(scene, camera);
    }

    function resize(){
      const w = window.innerWidth, h = window.innerHeight;
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w,h,false);
    }
    window.addEventListener('resize', resize, { passive:true });
    resize();
  </script>
</body>
</html>

