<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WebAR</title>

<script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
html,body{margin:0;height:100%;overflow:hidden;background:#000;}
video,canvas{
position:fixed!important;
top:0!important;left:0!important;
width:100%!important;height:100%!important;
object-fit:cover!important;
}
#ui{
position:fixed;inset:0;z-index:10;
display:flex;align-items:center;justify-content:center;
background:linear-gradient(180deg,#020028 0%,#001FA8 100%);
}
#start{
padding:18px 40px;
border:0;border-radius:28px;
font:700 28px system-ui;
background:#ff0a5c;color:#fff;
}
</style>
</head>

<body>

<div id="ui">
<button id="start">Start AR</button>
</div>

<a-scene
mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; filterMinCF:0.0001; filterBeta:0.005;"
embedded
color-space="sRGB"
renderer="alpha:true; antialias:true; physicallyCorrectLights:true;"
vr-mode-ui="enabled:false"
device-orientation-permission-ui="enabled:false"
>

<a-assets>
<a-asset-item id="ladybugs" src="./models/Ladybugs.glb"></a-asset-item>
<a-asset-item id="dragonflies" src="./models/Dragonflies.glb"></a-asset-item>
<a-asset-item id="butterflies" src="./models/Butterflies.glb"></a-asset-item>
</a-assets>

<a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

<a-entity mindar-image-target="targetIndex:0">
<a-entity class="smooth">
<a-gltf-model src="#ladybugs"
scale="2 2 2"
animation-mixer
class="model"
visible="false">
</a-gltf-model>
</a-entity>
</a-entity>

<a-entity mindar-image-target="targetIndex:1">
<a-entity class="smooth">
<a-gltf-model src="#dragonflies"
scale="2 2 2"
animation-mixer
class="model"
visible="false">
</a-gltf-model>
</a-entity>
</a-entity>

<a-entity mindar-image-target="targetIndex:2">
<a-entity class="smooth">
<a-gltf-model src="#butterflies"
scale="2 2 2"
animation-mixer
class="model"
visible="false">
</a-gltf-model>
</a-entity>
</a-entity>

</a-scene>

<script>

AFRAME.registerComponent('ultrastable', {
init:function(){
this.obj=this.el.object3D
this.pos=new THREE.Vector3()
this.quat=new THREE.Quaternion()
this.scale=new THREE.Vector3()
this.tmpPos=new THREE.Vector3()
this.tmpQuat=new THREE.Quaternion()
this.tmpScale=new THREE.Vector3()
this.visible=false
this.lastSeen=0

this.el.parentNode.addEventListener('targetFound',()=>{
this.visible=true
this.lastSeen=performance.now()
})

this.el.parentNode.addEventListener('targetLost',()=>{
this.lastSeen=performance.now()
})
},
tick:function(t,dt){

this.el.parentNode.object3D.getWorldPosition(this.tmpPos)
this.el.parentNode.object3D.getWorldQuaternion(this.tmpQuat)
this.el.parentNode.object3D.getWorldScale(this.tmpScale)

if(!this.pos.length()){
this.pos.copy(this.tmpPos)
this.quat.copy(this.tmpQuat)
this.scale.copy(this.tmpScale)
}

let dist=this.pos.distanceTo(this.tmpPos)
let angle=2*Math.acos(Math.min(1,Math.abs(this.quat.dot(this.tmpQuat))))

if(dist>0.2||angle>0.3){
this.pos.lerp(this.tmpPos,0.4)
this.quat.slerp(this.tmpQuat,0.4)
this.scale.lerp(this.tmpScale,0.4)
}else{
this.pos.lerp(this.tmpPos,0.08)
this.quat.slerp(this.tmpQuat,0.08)
this.scale.lerp(this.tmpScale,0.08)
}

this.obj.position.copy(this.pos)
this.obj.quaternion.copy(this.quat)
this.obj.scale.copy(this.scale)

let models=this.el.querySelectorAll('.model')
if(this.visible){
models.forEach(m=>m.setAttribute('visible',true))
}else{
if(performance.now()-this.lastSeen>300){
models.forEach(m=>m.setAttribute('visible',false))
}
}
}
})

document.querySelectorAll('.smooth').forEach(el=>{
el.setAttribute('ultrastable','')
})

const scene=document.querySelector('a-scene')
document.getElementById('start').addEventListener('click',async()=>{
await scene.systems["mindar-image-system"].start()
document.getElementById('ui').style.display='none'
})

</script>

</body>
</html>
